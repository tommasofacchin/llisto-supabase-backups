name: Supabase database backup to S3

on:
  schedule:
    - cron: "0 2 * * *" 
  workflow_dispatch:      

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Set backup filename
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H-%M-%SZ")
          echo "FILE_NAME=supabase-$TIMESTAMP.sql.gz" >> $GITHUB_ENV

      - name: Dump Supabase database
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          pg_dump "$SUPABASE_DB_URL" \
            --clean \
            --if-exists \
            --no-owner \
            --no-privileges \
            | gzip > "${FILE_NAME}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload backup to S3
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          YEAR_MONTH=$(date -u +"%Y/%m")
          aws s3 cp "${FILE_NAME}" "s3://${S3_BUCKET_NAME}/supabase/${YEAR_MONTH}/${FILE_NAME}"
